
-- CREATE TABLE IF NOT EXISTS `object_ids` (
--     `id` varchar(50) NOT NULL COMMENT  'id',
--     PRIMARY KEY (`id`)
-- ) COMMENT 'object_ids' DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci;
-- insert into object_ids values
--     ('60c1ac2cbb80d0962f8dbd8e'),
--     ('60c1ac2cbb80d0962f8dbd8f'),
--     ('60c1ac2cbb80d0962f8dbd90'),
--     ('60c1ac2cbb80d0962f8dbd91'),
--     ('60c1ac2cbb80d0962f8dbd92'),
--     ('60c1ac2cbb80d0962f8dbd93'),
--     ('60c1ac2cbb80d0962f8dbd94'),
--     ('60c1ac2cbb80d0962f8dbd95'),
--     ('60c1ac2cbb80d0962f8dbd96'),
--     ('60c1ac2cbb80d0962f8dbd97'),
--     ('60c1ac2cbb80d0962f8dbd98'),
--     ('60c1ac2cbb80d0962f8dbd99'),
--     ('60c1ac2cbb80d0962f8dbd9a'),
--     ('60c1ac2cbb80d0962f8dbd9b'),
--     ('60c1ac2cbb80d0962f8dbd9c'),
--     ('60c1ac2cbb80d0962f8dbd9d'),
--     ('60c1ac2cbb80d0962f8dbd9e'),
--     ('60c1ac2cbb80d0962f8dbd9f'),
--     ('60c1ac2cbb80d0962f8dbda0'),
--     ('60c1ac2cbb80d0962f8dbda1'),
--     ('60c1ac2cbb80d0962f8dbda2'),
--     ('60c1ac2cbb80d0962f8dbda3'),
--     ('60c1ac2cbb80d0962f8dbda4'),
--     ('60c1ac2cbb80d0962f8dbda5'),
--     ('60c1ac2cbb80d0962f8dbda6'),
--     ('60c1ac2cbb80d0962f8dbda7'),
--     ('60c1ac2cbb80d0962f8dbda8'),
--     ('60c1ac2cbb80d0962f8dbda9'),
--     ('60c1ac2cbb80d0962f8dbdaa'),
--     ('60c1ac2cbb80d0962f8dbdab'),
--     ('60c1ac2cbb80d0962f8dbdac'),
--     ('60c1ac2cbb80d0962f8dbdad'),
--     ('60c1ac2cbb80d0962f8dbdae'),
--     ('60c1ac2cbb80d0962f8dbdaf'),
--     ('60c1ac2cbb80d0962f8dbdb0'),
--     ('60c1ac2cbb80d0962f8dbdb1'),
--     ('60c1ac2cbb80d0962f8dbdb2'),
--     ('60c1ac2cbb80d0962f8dbdb3'),
--     ('60c1ac2cbb80d0962f8dbdb4'),
--     ('60c1ac2cbb80d0962f8dbdb5'),
--     ('60c1ac2cbb80d0962f8dbdb6'),
--     ('60c1ac2cbb80d0962f8dbdb7'),
--     ('60c1ac2cbb80d0962f8dbdb8'),
--     ('60c1ac2cbb80d0962f8dbdb9'),
--     ('60c1ac2cbb80d0962f8dbdba'),
--     ('60c1ac2cbb80d0962f8dbdbb'),
--     ('60c1ac2cbb80d0962f8dbdbc'),
--     ('60c1ac2cbb80d0962f8dbdbd'),
--     ('60c1ac2cbb80d0962f8dbdbe'),
--     ('60c1ac2cbb80d0962f8dbdbf'),
--     ('60c1ac2cbb80d0962f8dbdc0'),
--     ('60c1ac2cbb80d0962f8dbdc1'),
--     ('60c1ac2cbb80d0962f8dbdc2'),
--     ('60c1ac2cbb80d0962f8dbdc3'),
--     ('60c1ac2cbb80d0962f8dbdc4'),
--     ('60c1ac2cbb80d0962f8dbdc5'),
--     ('60c1ac2cbb80d0962f8dbdc6'),
--     ('60c1ac2cbb80d0962f8dbdc7'),
--     ('60c1ac2cbb80d0962f8dbdc8'),
--     ('60c1ac2cbb80d0962f8dbdc9'),
--     ('60c1ac2cbb80d0962f8dbdca'),
--     ('60c1ac2cbb80d0962f8dbdcb'),
--     ('60c1ac2cbb80d0962f8dbdcc'),
--     ('60c1ac2cbb80d0962f8dbdcd'),
--     ('60c1ac2cbb80d0962f8dbdce'),
--     ('60c1ac2cbb80d0962f8dbdcf'),
--     ('60c1ac2cbb80d0962f8dbdd0'),
--     ('60c1ac2cbb80d0962f8dbdd1'),
--     ('60c1ac2cbb80d0962f8dbdd2'),
--     ('60c1ac2cbb80d0962f8dbdd3'),
--     ('60c1ac2cbb80d0962f8dbdd4'),
--     ('60c1ac2cbb80d0962f8dbdd5'),
--     ('60c1ac2cbb80d0962f8dbdd6'),
--     ('60c1ac2cbb80d0962f8dbdd7'),
--     ('60c1ac2cbb80d0962f8dbdd8'),
--     ('60c1ac2cbb80d0962f8dbdd9'),
--     ('60c1ac2cbb80d0962f8dbdda'),
--     ('60c1ac2cbb80d0962f8dbddb'),
--     ('60c1ac2cbb80d0962f8dbddc'),
--     ('60c1ac2cbb80d0962f8dbddd'),
--     ('60c1ac2cbb80d0962f8dbdde'),
--     ('60c1ac2cbb80d0962f8dbddf'),
--     ('60c1ac2cbb80d0962f8dbde0'),
--     ('60c1ac2cbb80d0962f8dbde1'),
--     ('60c1ac2cbb80d0962f8dbde2'),
--     ('60c1ac2cbb80d0962f8dbde3'),
--     ('60c1ac2cbb80d0962f8dbde4'),
--     ('60c1ac2cbb80d0962f8dbde5'),
--     ('60c1ac2cbb80d0962f8dbde6'),
--     ('60c1ac2cbb80d0962f8dbde7'),
--     ('60c1ac2cbb80d0962f8dbde8'),
--     ('60c1ac2cbb80d0962f8dbde9'),
--     ('60c1ac2cbb80d0962f8dbdea'),
--     ('60c1ac2cbb80d0962f8dbdeb'),
--     ('60c1ac2cbb80d0962f8dbdec'),
--     ('60c1ac2cbb80d0962f8dbded'),
--     ('60c1ac2cbb80d0962f8dbdee'),
--     ('60c1ac2cbb80d0962f8dbdef'),
--     ('60c1ac2cbb80d0962f8dbdf0'),
--     ('60c1ac2cbb80d0962f8dbdf1');

-- select distinct organization_id from learning_outcomes where publish_status='published';

-- insert general milestone

insert into milestones (id, organization_id, ancestor_id, source_id, latest_id, name, status, type, create_at, update_at, shortcode, author_id)
select t.id, t.organization_id, t.id, t.id, t.id, 'General Milestone', 'published', 'general', t.tm, t.tm, '', '' from
    (select replace(UUID(), '-', '') as id, organization_id, unix_timestamp(now()) as tm from learning_outcomes where publish_status='published' and not exists
        (select * from milestones where type='general' and learning_outcomes.organization_id=milestones.organization_id) group by organization_id) as t where 1=1;

-- select * from milestones where type='general';

-- bind outcome with general milestone
insert into milestones_outcomes (milestone_id, outcome_ancestor, create_at, update_at)
select id as milestone_id, ancestor_id as outcome_ancestor, unix_timestamp(now()) as create_at, unix_timestamp(now()) as update_at from
    (select distinct ancestor_id, organization_id from learning_outcomes where publish_status='published' and delete_at=0) as oc
        join
    (select id, organization_id from milestones where type='general') as ms
    on oc.organization_id=ms.organization_id
where not exists
    (select * from milestones_outcomes where delete_at is null and milestone_id=ms.id and outcome_ancestor=oc.ancestor_id);

-- drop table object_ids;