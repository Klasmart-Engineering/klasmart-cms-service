include:
  - project: 'devops/ci-center'
    ref: 'master'
    file: 'gitlab-ci-kidsloopr/.gitlab-ci-cdk.yml'
  - project: 'devops/ci-center'
    ref: 'master'
    file: 'gitlab-ci-kidsloopr/.gitlab-ci-docker.yml'

stages:
  - deploy_swagger_global
  - deploy_swagger_cn
  - deploy_flyway_cn
  - deploy_flyway_cn_prod
  - build_cdk
  - deploy_cdk
  - deploy_cdk_release

.BASE_IMAGE: &BASE_IMAGE
  image: ccr.ccs.tencentyun.com/base_images/alpine:latest

.go-cache:
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  cache:
    paths:
      - .go/pkg/mod/

.DEPLOY_SECRET:
  before_script:
    - echo "Download the warehouse file and synchronize to the Swagger node"
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > deploy.key
    - chmod 600 deploy.key
    - ssh-add deploy.key
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

DEPLOY_SWAGGER_Global_JOB:
  <<: *BASE_IMAGE
  stage: deploy_swagger_global
  tags:
    - web-runner-aws
  extends:
    - .DEPLOY_SECRET
    - .go-cache
    - .DEPLOY_SWAGGER_GLBOAL
  rules:
    - if: '$CI_COMMIT_BRANCH == "global/test" && $CI_PIPELINE_SOURCE != "trigger"'
      when: on_success

DEPLOY_SWAGGER_CN_JOB:
  <<: *BASE_IMAGE
  stage: deploy_swagger_cn
  tags:
    - web-runner-aws
  extends:
    - .DEPLOY_SECRET
    - .go-cache
    - .DEPLOY_SWAGGER_CN
  rules:
    - if: '$CI_COMMIT_BRANCH == "cn/wukong" && $CI_PIPELINE_SOURCE != "trigger"'
      when: on_success

DEPLOY_FLYWAY_CN_JOB:
  <<: *BASE_IMAGE
  stage: deploy_flyway_cn
  tags:
    - web-runner-aws
  extends:
    - .DEPLOY_SECRET
    - .DEPLOY_FLYWAY_CN_QA
  rules:
    - if: '$CI_COMMIT_BRANCH == "cn/wukong" && $CI_PIPELINE_SOURCE != "trigger"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "cn/ghost" && $CI_PIPELINE_SOURCE != "trigger"'
      when: on_success
    - if: '$CI_COMMIT_TAG =~ /^dev\/cn\/shaolin\/[\w\-\.]+$/ && $CI_PIPELINE_SOURCE != "trigger"'
      when: on_success

DEPLOY_FLYWAY_CN_PROD_JOB:
  <<: *BASE_IMAGE
  stage: deploy_flyway_cn_prod
  tags:
    - web-runner-aws
  extends:
    - .DEPLOY_SECRET
    - .DEPLOY_FLYWAY_CN_PROD
  rules:
    - if: '$CI_COMMIT_TAG =~ /^release\/.*$/ && $CI_PIPELINE_SOURCE != "trigger"'
      when: on_success
  resource_group: $CI_JOB_NAME


Build_Go_Push:
  stage: build_cdk
  tags:
    - kidsloop2
  extends:
    - .TIGGER_RULES_CHECK
    - .EXECUTEBUILD_JOB
  resource_group: $CI_JOB_NAME


Deploy_To_Lambda_Push:
  extends:
    - .TIGGER_RULES_DEPLOY
    - .PACKAGEZIP_UPDATECDK
  stage: deploy_cdk
  tags:
    - kidsloop2
  resource_group: $CI_JOB_NAME

#############################################
############# BELOW FOR ops-dev #############
#############################################
.OPS_DEV_BEFORE_SCRIPT:
  before_script:
    # switch to the correct branch in niobium
    - set -e
    - niobium_dir="$HOME/devops/niobium"
    - git clone git@gitlab.badanamu.com.cn:devops/niobium.git "$niobium_dir"
    - cd "$niobium_dir"
    - git checkout $CI_COMMIT_TAG
    - cd -

OPS_DEV_BUILD:
  stage: build_cdk
  tags:
    - ops-dev
  extends:
    - .OPS_DEV_BEFORE_SCRIPT
    - .EXECUTEBUILD_JOB
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(ops-dev\/).*$/ && $CI_PIPELINE_SOURCE != "trigger"'

OPS_DEV_DEPLOY:
  stage: deploy_cdk
  tags:
    - ops-dev
  extends:
    - .OPS_DEV_BEFORE_SCRIPT
    - .PACKAGEZIP_UPDATECDK
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(ops-dev\/).*$/ && $CI_PIPELINE_SOURCE == "trigger"'
