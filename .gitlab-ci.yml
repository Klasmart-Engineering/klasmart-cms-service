include:
  - project: 'devops/ci-center'
    ref: 'master'
    file: 'gitlab-ci-kidsloopr/.gitlab-ci-docker.yml'

stages:
  - deploy_swagger_global
  - build_loadtest_cms
  - deploy_ecs_cms

.BASE_IMAGE: &BASE_IMAGE
  image: ccr.ccs.tencentyun.com/base_images/alpine:latest

.go-cache:
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  cache:
    paths:
      - .go/pkg/mod/

.DEPLOY_SECRET:
  before_script:
    - echo "Download the warehouse file and synchronize to the Swagger node"
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" > deploy.key
    - chmod 600 deploy.key
    - ssh-add deploy.key
    - mkdir -p ~/.ssh
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'

DEPLOY_SWAGGER_Global_JOB:
  <<: *BASE_IMAGE
  stage: deploy_swagger_global
  tags:
    - web-runner-aws
  extends:
    - .DEPLOY_SECRET
    - .go-cache
    - .DEPLOY_SWAGGER_GLBOAL
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE != "trigger"'
      when: on_success
      

.build_cms:
  stage: build_loadtest_cms
  image: golang:1.18.0-alpine3.14
  cache:
    paths:
      - main
  tags:
    - web-runner-aws
  extends:
    - .go-cache
    - BUILD_LOADTEST_CMS
  rules:
  - if '$CI_COMMIT_BRANCH =~ /^(loadtest).*$/'
    when: on_success

.deploy_ecs_cms:
  stage: deploy_ecs_cms
  image: docker:latest
  variables:
    DOCKER_DRIVER: overlay
    DOCKER_HOST: tcp://localhost:2375
  cache:
    paths:
      - main
  tags:
    - web-runner-aws
  extends:
    - DEPLOY_ECS_CMS
  rules:
  - if '$CI_COMMIT_BRANCH =~ /^(loadtest).*$/'
    when: on_success