name: Build and Push image to ECR

on:
  push:
    branches:
      - hotfix/*
      - main
      - id-build
  workflow_dispatch:

env:
  H5P_PRIVATE_KEY: ${{ secrets.H5P_PRIVATE_KEY }}
  H5P_PUBLIC_KEY: ${{ secrets.H5P_PUBLIC_KEY }}
  JWT_PUBLIC_KEY: ${{ secrets.JWT_PUBLIC_KEY }}
  AMS_ASSESSMENT_JWT_PUBLIC_KEY: ${{ secrets.AMS_ASSESSMENT_JWT_PUBLIC_KEY }}
  LIVE_TOKEN_PRIVATE_KEY: ${{ secrets.LIVE_TOKEN_PRIVATE_KEY }}
  STM_INTERNAL_PUBLIC_KEY: ${{ secrets.STM_INTERNAL_PUBLIC_KEY }}

  SERVER_PRIVATE_KEY: ${{ secrets.SERVER_PRIVATE_KEY }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SERVER_PORT: ${{secrets.SERVER_PORT}}
  SERVER_DESTINATION: ${{secrets.SERVER_DESTINATION}}

  GIT_TOKEN: ${{ secrets.PACKAGES_TOKEN_SETH }}

jobs:
  build-to-ecr:
    name: Build And Deploy ECS
    runs-on: ubuntu-latest
    steps:
      # - name: Build and Push Container
      #   uses: KL-Engineering/kidsloop-action-center/.github/actions/gocache@v1.0.0
      #   with:
      #     GIT_TOKEN: ${{ secrets.PACKAGES_TOKEN_SETH }}

      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18

      - name: Cache Go Modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Configure git credentials
        run: |
          git config --global url.https://$GIT_TOKEN@github.com/.insteadOf https://github.com/

      - name: Build
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o deploy/handler -ldflags "-X github.com/KL-Engineering/kidsloop-cms-service/constant.GitHash=$(git rev-list -1 HEAD) -X github.com/KL-Engineering/kidsloop-cms-service/constant.BuildTimestamp=$(date +%s) -X github.com/KL-Engineering/kidsloop-cms-service/constant.LatestMigrate=$(ls schema/migrate | tail -1)"

      - name: prepare tokens
        env:
          H5P_PRIVATE_KEY: ${{ env.H5P_PRIVATE_KEY }}
          H5P_PUBLIC_KEY: ${{ env.H5P_PUBLIC_KEY }}
          JWT_PUBLIC_KEY: ${{ env.JWT_PUBLIC_KEY }}
          AMS_ASSESSMENT_JWT_PUBLIC_KEY: ${{ env.AMS_ASSESSMENT_JWT_PUBLIC_KEY }}
          LIVE_TOKEN_PRIVATE_KEY: ${{ env.LIVE_TOKEN_PRIVATE_KEY }}
          STM_INTERNAL_PUBLIC_KEY: ${{ env.STM_INTERNAL_PUBLIC_KEY }}
        run: |
          echo "$H5P_PRIVATE_KEY" | base64 -d > deploy/h5p_private_key.pem
          echo "$H5P_PUBLIC_KEY" | base64 -d > deploy/h5p_public_key.pem
          echo "$JWT_PUBLIC_KEY" | base64 -d > deploy/jwt_public_key.pem
          echo "$AMS_ASSESSMENT_JWT_PUBLIC_KEY" | base64 -d > deploy/ams_assessment_jwt_public_key.pem
          echo "$LIVE_TOKEN_PRIVATE_KEY" | base64 -d > deploy/live_token_private_key.pem
          echo "$STM_INTERNAL_PUBLIC_KEY" | base64 -d > deploy/stm_internal_public_key.pem

      # - name: Build and Push Container
      #   uses: KL-Engineering/kidsloop-action-center/.github/actions/docker-build-and-push@v1.0.0
      #   with:
      #     environment: ${{ needs.generate-version.outputs.tag }}
      #     region: global
      #     ecr_repository: kidsloop-cms-backend
      #     dockerfile_dir: deploy
      #     dockerfile_name: Dockerfile
      #     dockerfile_context: .
      #     ecr_aws_region: ap-southeast-3
      #     ecr_registry: 789939988543.dkr.ecr.ap-southeast-3.amazonaws.com
      #     ECR_AWS_ACCESS_KEY_ID: ${{ secrets.ID_ECR_AWS_ACCESS_KEY_ID }}
      #     ECR_AWS_SECRET_ACCESS_KEY: ${{ secrets.ID_ECR_AWS_SECRET_ACCESS_KEY }}
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.ID_ECR_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.ID_ECR_AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-3

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and Push Container
        shell: bash
        env:
          ECR_REGISTRY: 789939988543.dkr.ecr.ap-southeast-3.amazonaws.com
          ECR_REPOSITORY: kidsloop-cms-backend
          ENVIRONMENT: ${{ needs.generate-version.outputs.tag }}
          REGION: global
        run: |
          set +x
          export BRANCH_TAG=$(echo "${GITHUB_REF_NAME}" | sed -E 's/([^0-9a-zA-Z\.]+)/-/g' | awk '{print tolower($0)}')
          printf '"BRANCH_TAG":"%s", "Git commit":"%s"' $BRANCH_TAG ${GITHUB_SHA::7}
          docker build -t $ECR_REPOSITORY:$BRANCH_TAG-latest deploy/
          docker tag $ECR_REPOSITORY:$BRANCH_TAG-latest $ECR_REGISTRY/$ECR_REPOSITORY:$BRANCH_TAG-${GITHUB_SHA::7}
          docker tag $ECR_REPOSITORY:$BRANCH_TAG-latest $ECR_REGISTRY/$ECR_REPOSITORY:alpha-dev-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:alpha-dev-latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$BRANCH_TAG-${GITHUB_SHA::7}
