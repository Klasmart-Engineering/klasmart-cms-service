name: Deploy to Swagger

on:
  push:
    branches: [ main ]

env:
  SERVER_PRIVATE_KEY: ${{ secrets.SERVER_PRIVATE_KEY }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SERVER_PORT: ${{secrets.SERVER_PORT}}
  SERVER_DESTINATION: ${{secrets.SERVER_DESTINATION}}

jobs:
  build-swag:
    name: Build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.18
  
    - name: Cache Go Modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Build SWAG
      run: |
        go env -w GOPROXY="https://goproxy.cn,direct"
        go env -w GOPRIVATE="bitbucket.org"
    - name: Install SWAG
      run: go install github.com/swaggo/swag/cmd/swag@v1.8.1
    - name: Build SWAG
      run: swag init
    - name: COPY JSON File
      run: |
        cp docs/swagger.json api.swagger.json
        ls -la
        echo $PWD

    - name: Upload result
      uses: actions/upload-artifact@v3
      with:
        name: swag
        path: api.swagger.json
        if-no-files-found: error
        retention-days: 3

  deploy:
    name: Deploy
    needs: build-swag
    runs-on: ubuntu-latest
    steps:
      - name: Download result
        uses: actions/download-artifact@v3
        with:
          name: swag
      - name: Display structure of downloaded files
        run: ls -la

      - name: Deploy to Server
        uses: AEnterprise/rsync-deploy@v1.0
        env:
          DEPLOY_KEY: ${{ env.SERVER_PRIVATE_KEY }}
          ARGS: "-avz --delete"
          SERVER_PORT: ${{ env.SERVER_PORT }}
          FOLDER: ./
          SERVER_IP: ${{ env.SERVER_IP }}
          USERNAME: ${{ env.SERVER_USER }}
          SERVER_DESTINATION: ${{ env.SERVER_DESTINATION }}
